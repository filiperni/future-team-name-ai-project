<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Future Team Name</title>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
			type="text/css"
		/>
		<link rel="stylesheet" href="./style.css" type="text/css" />
		<style></style>
		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
	</head>

	<body>
		<div id="map" class="map"></div>
		<div class="lds-ring" id="loading-animation">
			<div></div>
			<div></div>
			<div></div>
			<div></div>
		</div>
		<div id="input">
			<div id="pointA">
				Point A (Start): <br />
				<!-- Point A - lon and lan -->
				Longitude: <input type="text" id="lonA" name="lonA" /> Latitude:
				<input type="text" id="latA" name="latA" />
				<!-- clear button-->
				<button type="button" id="clearA">Clear</button>
			</div>

			<div id="pointB">
				Point B (End): <br />
				<!-- Point B - lon and lan -->
				Longitude: <input type="text" id="lonB" name="lonB" /> Latitude:
				<input type="text" id="latB" name="latB" />
				<!-- clear button-->
				<button type="button" id="clearB">Clear</button>
			</div>
			<div id="path">
				<!-- create path button-->
				<button type="button" id="createPath">Show Best Route</button>
			</div>
		</div>

		<script type="text/javascript">
			var posA = {};
			var posB = {};
			//create random path from pointA to pointB with 10 points saved as lon and lat in array
			var createRandomPath = function (pointA, pointB, stepsCount) {
				var path = [];
				path.push([pointA[0], pointA[1]]);
				var step = {
					lon: (pointB[0] - pointA[0]) / stepsCount,
					lat: (pointB[1] - pointA[1]) / stepsCount,
				};
				for (var i = 1; i < stepsCount; i++) {
					var point = {
						lon:
							pointA[0] + i * step.lon + Math.random() * step.lon,
						lat:
							pointA[1] + i * step.lat + Math.random() * step.lat,
					};
					path.push([point.lon, point.lat]);
				}
				path.push([pointB[0], pointB[1]]);
				return path;
			};
			const svg_pin =
				'<svg width="24" height="24" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg">' +
				'<path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12 ,2Z" fill="firebrick"></path>' +
				"</svg>";

			var clearA = document.getElementById("clearA");
			clearA.addEventListener(
				"click",
				function () {
					document.getElementById("lonA").value = "";
					document.getElementById("latA").value = "";
					posA = {};
					changePositionTo(markerA, "", "");
					pathFeature.setGeometry();
				},
				false
			);

			var clearB = document.getElementById("clearB");
			clearB.addEventListener(
				"click",
				function () {
					document.getElementById("lonB").value = "";
					document.getElementById("latB").value = "";
					posB = {};
					changePositionTo(markerB, "", "");
					pathFeature.setGeometry();
				},
				false
			);

			function createPathFunction() {
				var pointA = ol.proj.fromLonLat([
					document.getElementById("lonA").value,
					document.getElementById("latA").value,
				]);
				var pointB = ol.proj.fromLonLat([
					document.getElementById("lonB").value,
					document.getElementById("latB").value,
				]);
				var path = createRandomPath(pointA, pointB, 10);
				console.log("path", path);
				var startingWalkingPathCoordinates = new ol.geom.LineString([
					path[0],
					path[1],
				]);
				var endingWalkingPathCoordinates = new ol.geom.LineString([
					path[path.length - 1],
					path[path.length - 2],
				]);
				var redPathLine = new ol.geom.LineString(path);
				pathFeature.setGeometry(redPathLine);
				endingWalkingPath.setGeometry(endingWalkingPathCoordinates);
				walkingPath.setGeometry(startingWalkingPathCoordinates);
			}

			var createPath = document.getElementById("createPath");
			createPath.addEventListener("click", createPathFunction, false);

			var markerA = new ol.Feature({
				geometry: new ol.geom.Point(
					ol.proj.fromLonLat([
						document.getElementById("lonA").value,
						document.getElementById("latA").value,
					])
				),
			});

			var markerB = new ol.Feature({
				geometry: new ol.geom.Point(
					ol.proj.fromLonLat([
						document.getElementById("lonB").value,
						document.getElementById("latB").value,
					])
				),
			});

			var markers = new ol.layer.Vector({
				source: new ol.source.Vector({
					features: [markerA, markerB],
				}),
			});

			var iconStyle = new ol.style.Style({
				image: new ol.style.Icon({
					anchor: [0.5, 0.9],
					anchorXUnits: "fraction",
					anchorYUnits: "fraction",
					opacity: 1,
					src: "data:image/svg+xml;utf8," + svg_pin,
					scale: 1.5,
				}),
			});

			markerA.setStyle(iconStyle);
			markerB.setStyle(iconStyle);

			var osm = new ol.layer.Tile({
				source: new ol.source.OSM(),
			});

			var map = new ol.Map({
				layers: [osm],
				target: document.getElementById("map"),
				view: new ol.View({
					center: ol.proj.fromLonLat([
						18.606624528808595, 54.38186473556618,
					]),
					zoom: 12,
				}),
			});

			//create random path from pointA to pointB
			var pointA = ol.proj.fromLonLat([
				document.getElementById("lonA").value,
				document.getElementById("latA").value,
			]);
			var pointB = ol.proj.fromLonLat([
				document.getElementById("lonB").value,
				document.getElementById("latB").value,
			]);
			var path = createRandomPath(pointA, pointB, 10);
			var pathLine = new ol.geom.LineString(path);

			var pathFeature = new ol.Feature({
				geometry: pathLine,
			});

			var pathSource = new ol.source.Vector({
				features: [pathFeature],
			});

			var pathLayer = new ol.layer.Vector({
				source: pathSource,
			});

			var pathStyle = new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: "red",
					width: 2,
				}),
			});

			pathFeature.setStyle(pathStyle);

			map.addLayer(markers);
			map.addLayer(pathLayer);

			var walkingPath = new ol.Feature({
				geometry: pathLine,
			});

			var walkingPathSource = new ol.source.Vector({
				features: [walkingPath],
			});

			var walkingPathLayer = new ol.layer.Vector({
				source: walkingPathSource,
			});

			var walkingPathStyle = new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: "blue",
					width: 2,
				}),
			});

			walkingPath.setStyle(walkingPathStyle);
			map.addLayer(walkingPathLayer);

			var endingWalkingPath = new ol.Feature({
				geometry: pathLine,
			});

			var endingWalkingPathSource = new ol.source.Vector({
				features: [endingWalkingPath],
			});

			var endingWalkingPathLayer = new ol.layer.Vector({
				source: endingWalkingPathSource,
			});

			var endingWalkingPathStyle = new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: "blue",
					width: 2,
				}),
			});

			endingWalkingPath.setStyle(endingWalkingPathStyle);
			map.addLayer(endingWalkingPathLayer);

			var translateA = new ol.interaction.Translate({
				features: new ol.Collection([markerA]),
			});

			var translateB = new ol.interaction.Translate({
				features: new ol.Collection([markerB]),
			});

			map.addInteraction(translateA);
			map.addInteraction(translateB);

			translateA.on("translateend", HandleMapIconDragA);
			translateB.on("translateend", HandleMapIconDragB);

			function HandleMapIconDragA(e) {
				var p = e.features.getArray()[0].getGeometry().getCoordinates();
				p = ol.proj.transform(p, "EPSG:3857", "EPSG:4326");
				// p now holds the [ lon, lat ] value of the dragged point icon
				posA["x"] = p[0];
				posA["y"] = p[1];
				document.getElementById("lonA").value = p[0];
				document.getElementById("latA").value = p[1];
				console.log(posA, p);
				updateRoute();
			}

			function HandleMapIconDragB(e) {
				var p = e.features.getArray()[0].getGeometry().getCoordinates();
				p = ol.proj.transform(p, "EPSG:3857", "EPSG:4326");
				// p now holds the [ lon, lat ] value of the dragged point icon
				posB["x"] = p[0];
				posB["y"] = p[1];
				document.getElementById("lonB").value = p[0];
				document.getElementById("latB").value = p[1];
				console.log(posB, p);
				updateRoute();
			}

			function changePositionTo(object_on_map, x, y) {
				object_on_map.setGeometry(
					new ol.geom.Point(ol.proj.fromLonLat([x, y]))
				);
			}
			function startLoadingAnimation() {
				document.getElementById("loading-animation").style.display =
					"inline-block";
			}

			function stopLoadingAnimation() {
				document.getElementById("loading-animation").style.display =
					"none";
			}
			function updateRoute() {
				if (posA["x"] !== undefined && posB["x"] !== undefined) {
					console.log("fetch");
					startLoadingAnimation();
					pathFeature.setGeometry();
					walkingPath.setGeometry();
					endingWalkingPath();
					fetch(
						`http://127.0.0.1:8000/?posAx=${posA["x"]}&posAy=${posA["y"]}&posBx=${posB["x"]}&posBy=${posB["y"]}`
					)
						.then(response => {
							stopLoadingAnimation();
							console.log("fetch result");
							createPathFunction();
							return response.json();
						})
						.then(res => {
							console.log(res);
						})
						.catch(err => {
							stopLoadingAnimation();
							console.error(err);
						});
				}
			}

			map.on("singleclick", function (evt) {
				var lonlat = ol.proj.transform(
					evt.coordinate,
					"EPSG:3857",
					"EPSG:4326"
				);
				if (document.getElementById("lonA").value == "") {
					document.getElementById("lonA").value = lonlat[0];
					document.getElementById("latA").value = lonlat[1];
					posA["x"] = lonlat[0];
					posA["y"] = lonlat[1];
				} else {
					document.getElementById("lonB").value = lonlat[0];
					document.getElementById("latB").value = lonlat[1];
					posB["x"] = lonlat[0];
					posB["y"] = lonlat[1];
				}
				updateRoute();

				console.log(posA, posB);
				// update markerVectorLayer
				changePositionTo(markerA, posA["x"], posA["y"]);
				changePositionTo(markerB, posB["x"], posB["y"]);
			});
		</script>
	</body>
</html>
